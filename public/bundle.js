(()=>{"use strict";const e="https://fsp-ln45.onrender.com";class t{constructor(){this.currentSession=null,this.currentWorker=null,this.components=[],this.workers=[],this.sessionLogs=[],this.initializeEventListeners(),this.loadInitialData()}initializeEventListeners(){document.getElementById("workerSelect").addEventListener("change",e=>{this.handleWorkerSelection(e.target.value)}),document.getElementById("startSessionBtn").addEventListener("click",()=>{this.startInstallationSession()}),document.getElementById("scanBtn").addEventListener("click",()=>{this.scanComponent()}),document.getElementById("componentScanner").addEventListener("keypress",e=>{"Enter"===e.key&&this.scanComponent()}),document.getElementById("installCompleteBtn").addEventListener("click",()=>{this.markInstallationComplete()}),document.getElementById("completeSessionBtn").addEventListener("click",()=>{this.completeSession()}),document.getElementById("resetSessionBtn").addEventListener("click",()=>{this.resetSession()}),document.getElementById("acknowledgeErrorBtn").addEventListener("click",()=>{this.acknowledgeError()}),document.getElementById("viewStatsBtn").addEventListener("click",()=>{this.showStatistics()}),document.getElementById("viewSessionsBtn").addEventListener("click",()=>{this.showAllSessions()}),document.getElementById("resetDbBtn").addEventListener("click",()=>{this.resetDatabase()}),document.querySelectorAll(".modal-close").forEach(e=>{e.addEventListener("click",e=>{this.closeModal(e.target.closest(".modal"))})}),document.querySelectorAll(".modal").forEach(e=>{e.addEventListener("click",t=>{t.target===e&&this.closeModal(e)})})}async loadInitialData(){try{this.showLoading();const[t,n]=await Promise.all([fetch(`${e}/api/workers`),fetch(`${e}/api/components`)]);if(!t.ok||!n.ok)throw new Error("Failed to load initial data");this.workers=await t.json(),this.components=await n.json(),this.populateWorkerSelect(),this.hideLoading()}catch(e){console.error("Error loading initial data:",e),this.showToast("Error loading initial data","error"),this.hideLoading()}}populateWorkerSelect(){const e=document.getElementById("workerSelect");e.innerHTML='<option value="">Select a worker...</option>',this.workers.forEach(t=>{const n=document.createElement("option");n.value=t.id,n.textContent=`${t.name} (${t.employee_id})`,e.appendChild(n)})}handleWorkerSelection(e){document.getElementById("startSessionBtn").disabled=!e,e&&(this.currentWorker=this.workers.find(t=>t.id===e))}async startInstallationSession(){if(this.currentWorker)try{this.showLoading();const t=await fetch(`${e}/api/sessions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({worker_id:this.currentWorker.id})});if(!t.ok)throw new Error("Failed to start session");this.currentSession=await t.json(),this.sessionLogs=[],this.showInstallationSession(),this.updateSessionInfo(),this.showToast("Sesi pemasangan bermula dengan jayanya","success")}catch(e){console.error("Error starting session:",e),this.showToast("Error starting session","error")}finally{this.hideLoading()}else this.showToast("Sila pilih pekerja terlebih dahulu","error")}showInstallationSession(){document.getElementById("workerSelection").classList.add("hidden"),document.getElementById("installationSession").classList.remove("hidden"),document.getElementById("componentScanner").focus()}updateSessionInfo(){this.currentSession&&this.currentWorker&&(document.getElementById("sessionWorker").textContent=`Worker: ${this.currentWorker.name}`,document.getElementById("sessionTime").textContent=`Started: ${this.formatTime(this.currentSession.start_time)}`,document.getElementById("sessionStatus").textContent=`Status: ${this.currentSession.status}`)}async scanComponent(){const t=document.getElementById("componentScanner").value.trim();if(t)if(this.currentSession){this.removeWarningMessage();try{this.showLoading();const n=await fetch(`${e}/api/sessions/${this.currentSession.session_id}/scan`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({partNumber:t})}),s=await n.json();if(!n.ok){if(s.isAlreadyInstalled)this.showToast("Komponen sudah dipasang. Sila periksa semula.","warning"),this.displayAlreadyInstalledComponent(s.component),this.disableScannerForAlreadyInstalled(),this.sessionLogs.push({component:s.component,scanTime:(new Date).toISOString(),isSequenceCorrect:!1,errorMessage:"Komponen sudah dipasang",isRepeatedScan:!0}),this.updateSessionStats();else if(s.isSequenceError)this.showToast(`Komponen ini sudah diimbas dengan ralat urutan: ${s.errorMessage}`,"error"),this.displayError(s.errorMessage,0),this.sessionLogs.push({component:s.component,scanTime:(new Date).toISOString(),isSequenceCorrect:!1,errorMessage:s.errorMessage,isRepeatedScan:!0}),this.updateSessionStats(),document.getElementById("componentScanner").disabled=!0,document.getElementById("scanBtn").disabled=!0,setTimeout(()=>{document.getElementById("componentScanner").disabled=!1,document.getElementById("scanBtn").disabled=!1},3e3);else{if(!s.isDuplicate)throw new Error(s.error||"Scan failed");this.showToast("Component already scanned","warning"),this.displayComponent(s.component,!0),this.sessionLogs.push({component:s.component,scanTime:(new Date).toISOString(),isSequenceCorrect:!1,errorMessage:"Komponen sudah diimbas",isRepeatedScan:!0}),this.updateSessionStats()}return}if(this.sessionLogs.push({component:s.component,scanTime:s.scanTime,isSequenceCorrect:s.isSequenceCorrect,errorMessage:s.errorMessage}),s.isBlocked)return this.displayBlockedError(s.errorMessage,s.wrongScansCount),void this.updateSessionStats();s.isSequenceCorrect?(this.hideError(),this.updateSessionStats(),s.showInstallationGuide&&(this.currentComponent=s.component,this.displayComponent(s.component,!1),this.showToast(`Komponen ${s.component.name} diimbas dengan jayanya. Selesaikan pemasangan sebelum mengimbas komponen seterusnya.`,"success"),document.getElementById("componentScanner").disabled=!0,document.getElementById("scanBtn").disabled=!0)):(this.displayError(s.errorMessage,s.wrongScansCount),this.updateSessionStats(),this.hideComponentDisplay(),document.getElementById("componentScanner").value="",this.showToast(`Urutan salah: ${s.errorMessage}`,"error"),s.canScan||(document.getElementById("componentScanner").disabled=!0,document.getElementById("scanBtn").disabled=!0)),document.getElementById("componentScanner").value="",document.getElementById("componentScanner").focus()}catch(e){console.error("Error scanning component:",e),this.showToast(`Error scanning component: ${e.message}`,"error")}finally{this.hideLoading()}}else this.showToast("No active session","error");else this.showToast("Sila masukkan nombor bahagian","warning")}displayComponent(e,t=!1){const n=document.getElementById("currentComponent");document.getElementById("componentName").textContent=e.name,document.getElementById("componentPartNumber").textContent=e.part_number,document.getElementById("componentDescription").textContent=e.description,document.getElementById("sequenceOrder").textContent=e.sequence_order,document.getElementById("guideSteps").textContent=e.installation_guide,n.classList.remove("hidden"),document.getElementById("installCompleteBtn").style.display="block",t?(n.style.borderColor="#f59e0b",n.style.background="linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)"):(n.style.borderColor="#0ea5e9",n.style.background="linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)")}displayAlreadyInstalledComponent(e){const t=document.getElementById("currentComponent");document.getElementById("componentName").textContent=e.name,document.getElementById("componentPartNumber").textContent=e.part_number,document.getElementById("componentDescription").textContent=e.description,document.getElementById("sequenceOrder").textContent=e.sequence_order,document.getElementById("guideSteps").innerHTML='\n            <div style="text-align: center; padding: 20px; color: #dc2626;">\n                <i class="fas fa-exclamation-triangle" style="font-size: 2em; margin-bottom: 10px;"></i>\n                <h4 style="color: #dc2626; margin: 0;">Komponen Sudah Dipasang!</h4>\n                <p style="margin: 10px 0; color: #6b7280;">\n                    Komponen ini telah ditandakan sebagai dipasang dalam sesi ini.\n                    Sila periksa semula urutan pemasangan anda.\n                </p>\n            </div>\n        ',document.getElementById("installCompleteBtn").style.display="none",t.classList.remove("hidden"),t.style.borderColor="#dc2626",t.style.background="linear-gradient(135deg, #fef2f2 0%, #fecaca 100%)"}disableScannerForAlreadyInstalled(){const e=document.getElementById("componentScanner"),t=document.getElementById("scanBtn");e.disabled=!0,t.disabled=!0;const n=document.querySelector(".scanner-section");let s=n.querySelector(".already-installed-warning");s||(s=document.createElement("div"),s.className="already-installed-warning",s.innerHTML='\n                <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 12px; margin-top: 10px; text-align: center;">\n                    <i class="fas fa-exclamation-triangle" style="color: #dc2626; margin-right: 8px;"></i>\n                    <span style="color: #dc2626; font-weight: 500;">\n                        Anda telah mengimbas komponen yang sudah dipasang. Sila periksa semula urutan pemasangan.\n                    </span>\n                    <div style="margin-top: 8px; font-size: 0.9em; color: #6b7280;">\n                        Scanner akan diaktifkan semula dalam 3 saat...\n                    </div>\n                </div>\n            ',n.appendChild(s)),setTimeout(()=>{e.disabled=!1,t.disabled=!1,s&&(s.innerHTML='\n                    <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 12px; margin-top: 10px; text-align: center;">\n                        <i class="fas fa-exclamation-triangle" style="color: #dc2626; margin-right: 8px;"></i>\n                        <span style="color: #dc2626; font-weight: 500;">\n                            Anda telah mengimbas komponen yang sudah dipasang. Sila periksa semula urutan pemasangan.\n                        </span>\n                        <div style="margin-top: 8px; font-size: 0.9em; color: #6b7280;">\n                            Scanner telah diaktifkan semula. Anda boleh terus mengimbas.\n                        </div>\n                    </div>\n                ')},3e3)}removeWarningMessage(){const e=document.querySelector(".already-installed-warning");e&&e.remove()}displayError(e,t){const n=document.getElementById("errorDisplay");document.getElementById("errorMessage").innerHTML=`\n            ${e}<br><br>\n            <strong>Imbasan salah dalam sesi ini: ${t}/3</strong><br>\n            ${t>=2?'<span style="color: #dc2626;">⚠️ AMARAN: Satu lagi imbasan salah akan menyekat sesi ini!</span>':""}\n        `,n.classList.remove("hidden"),document.getElementById("componentScanner").disabled=!0,document.getElementById("scanBtn").disabled=!0}displayBlockedError(e,t){const n=document.getElementById("errorDisplay");document.getElementById("errorMessage").innerHTML=`\n            <div style="color: #dc2626; font-size: 1.2em; margin-bottom: 1rem;">\n                🚫 <strong>SESI DISEKAT</strong> 🚫\n            </div>\n            ${e}<br><br>\n            <strong>Imbasan salah dalam sesi ini: ${t}/3</strong><br>\n            <span style="color: #dc2626; font-weight: bold;">\n                ⚠️ KRITIKAL: Anda telah melebihi had maksimum imbasan salah.<br>\n                Sesi ini kini disekat. Sila hubungi penyelia anda.\n            </span>\n        `,n.classList.remove("hidden"),document.getElementById("componentScanner").disabled=!0,document.getElementById("scanBtn").disabled=!0,document.getElementById("completeSessionBtn").disabled=!0,document.getElementById("resetSessionBtn").disabled=!0,this.showToast("SESI DISEKAT: Had maksimum imbasan salah terlampaui. Hubungi penyelia.","error")}hideError(){document.getElementById("errorDisplay").classList.add("hidden"),document.getElementById("componentScanner").disabled=!1,document.getElementById("scanBtn").disabled=!1}acknowledgeError(){if(this.sessionLogs.filter(e=>!e.isSequenceCorrect).length>=3)return void this.showToast("Sesi disekat. Hubungi penyelia anda untuk teruskan.","error");const e=this.sessionLogs.find(e=>"installed"===e.status);(e?e.component.sequence_order+1:1)<=this.components.length?(this.hideError(),this.showToast("Ralat diakui. Anda boleh terus mengimbas komponen seterusnya dalam urutan.","info")):this.showToast("Ralat diakui. Sila selesaikan pemasangan komponen semasa sebelum mengimbas komponen seterusnya.","warning")}hideComponentDisplay(){document.getElementById("currentComponent").classList.add("hidden")}async markInstallationComplete(){if(this.currentSession&&this.currentComponent)try{if(this.showLoading(),!(await fetch(`${e}/api/sessions/${this.currentSession.session_id}/install`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({componentId:this.currentComponent.id})})).ok)throw new Error("Failed to mark installation complete");const t=this.sessionLogs.findIndex(e=>e.component.id===this.currentComponent.id);-1!==t&&(this.sessionLogs[t].status="installed",this.sessionLogs[t].installTime=(new Date).toISOString()),this.hideComponentDisplay(),this.showToast(`Komponen ${this.currentComponent.name} ditandakan sebagai dipasang dengan jayanya`,"success"),this.updateSessionStats(),this.currentComponent=null,document.getElementById("componentScanner").disabled=!1,document.getElementById("scanBtn").disabled=!1}catch(e){console.error("Error marking installation complete:",e),this.showToast(`Error marking installation complete: ${e.message}`,"error")}finally{this.hideLoading()}else this.showToast("Tiada komponen aktif untuk ditandakan sebagai dipasang","error")}updateSessionStats(){this.sessionLogs.length;const e=this.sessionLogs.filter(e=>"installed"===e.status).length,t=this.sessionLogs.filter(e=>!e.isSequenceCorrect).length,n=e/this.components.length*100;document.getElementById("componentsCount").textContent=`${e}/${this.components.length}`,document.getElementById("errorsCount").textContent=`${t}/3`,document.getElementById("progressFill").style.width=`${n}%`;document.getElementById("progressFill").style.background=t>=3?"linear-gradient(90deg, #ef4444 0%, #dc2626 100%)":t>0?"linear-gradient(90deg, #f59e0b 0%, #d97706 100%)":"linear-gradient(90deg, #10b981 0%, #059669 100%)";const s=document.getElementById("errorsCount");t>=3?(s.style.color="#dc2626",s.style.fontWeight="bold"):t>=2?(s.style.color="#d97706",s.style.fontWeight="bold"):(s.style.color="#64748b",s.style.fontWeight="500"),t>=3&&this.checkAndBlockSession()}checkAndBlockSession(){const e=this.sessionLogs.filter(e=>!e.isSequenceCorrect).length;if(e>=3){this.displayBlockedError("Terlalu banyak ralat imbasan",e),document.getElementById("componentScanner").disabled=!0,document.getElementById("scanBtn").disabled=!0,document.getElementById("completeSessionBtn").disabled=!0,document.getElementById("resetSessionBtn").disabled=!0;const t=document.querySelector(".already-installed-warning");t&&t.remove()}}async completeSession(){if(this.currentSession)try{if(this.showLoading(),!(await fetch(`${e}/api/sessions/${this.currentSession.session_id}/complete`,{method:"PUT"})).ok)throw new Error("Failed to complete session");this.showToast("Sesi selesai dengan jayanya","success"),this.resetToWorkerSelection()}catch(e){console.error("Error completing session:",e),this.showToast("Error completing session","error")}finally{this.hideLoading()}else this.showToast("No active session","error")}resetSession(){this.sessionLogs.filter(e=>!e.isSequenceCorrect).length>=3?confirm("Sesi ini disekat kerana banyak imbasan salah. Menetapkan semula akan membersihkan sekatan dan membolehkan anda bermula semula. Teruskan?")&&this.resetToWorkerSelection():confirm("Adakah anda pasti mahu set semula sesi ini? Semua kemajuan akan hilang.")&&this.resetToWorkerSelection()}resetToWorkerSelection(){this.currentSession=null,this.currentWorker=null,this.currentComponent=null,this.sessionLogs=[],document.getElementById("installationSession").classList.add("hidden"),document.getElementById("workerSelection").classList.remove("hidden"),document.getElementById("currentComponent").classList.add("hidden"),document.getElementById("errorDisplay").classList.add("hidden"),document.getElementById("workerSelect").value="",document.getElementById("componentScanner").value="",document.getElementById("startSessionBtn").disabled=!0,document.getElementById("componentsCount").textContent="0/5",document.getElementById("errorsCount").textContent="0/3",document.getElementById("progressFill").style.width="0%",document.getElementById("componentScanner").disabled=!1,document.getElementById("scanBtn").disabled=!1;const e=document.querySelector(".already-installed-warning");e&&e.remove(),document.getElementById("installCompleteBtn").style.display="block"}async showStatistics(){try{this.showLoading();const t=await fetch(`${e}/api/sessions`);if(!t.ok)throw new Error("Failed to load sessions");const n=await t.json();this.displayStatistics(n),document.getElementById("statsModal").classList.remove("hidden")}catch(e){console.error("Error loading statistics:",e),this.showToast("Error loading statistics","error")}finally{this.hideLoading()}}displayStatistics(e){const t=document.getElementById("statsContent"),n=e.length,s=e.filter(e=>"completed"===e.status).length,o=e.reduce((e,t)=>e+t.components_installed,0),a=`\n            <div class="stats-grid">\n                <div class="stat-card">\n                    <h3>${n}</h3>\n                    <p>Jumlah Sesi</p>\n                </div>\n                <div class="stat-card">\n                    <h3>${s}</h3>\n                    <p>Sesi Selesai</p>\n                </div>\n                <div class="stat-card">\n                    <h3>${o}</h3>\n                    <p>Jumlah Komponen</p>\n                </div>\n                <div class="stat-card">\n                    <h3>${n>0?(o/n).toFixed(1):0}</h3>\n                    <p>Purata Komponen/Sesi</p>\n                </div>\n            </div>\n            \n            <h3>Sesi Terkini</h3>\n            <div class="sessions-table-container">\n                <table class="sessions-table">\n                    <thead>\n                                                 <tr>\n                             <th>Pekerja</th>\n                             <th>Masa Mula</th>\n                             <th>Status</th>\n                             <th>Komponen</th>\n                         </tr>\n                    </thead>\n                    <tbody>\n                        ${e.slice(0,10).map(e=>`\n                            <tr>\n                                <td>${e.worker_name}</td>\n                                <td>${this.formatTime(e.start_time)}</td>\n                                <td><span class="status-badge ${e.status}">${e.status}</span></td>\n                                <td>${e.components_installed}</td>\n                            </tr>\n                        `).join("")}\n                    </tbody>\n                </table>\n            </div>\n        `;t.innerHTML=a}async showAllSessions(){try{this.showLoading();const t=await fetch(`${e}/api/sessions`);if(!t.ok)throw new Error("Failed to load sessions");const n=await t.json();this.displayAllSessions(n),document.getElementById("sessionsModal").classList.remove("hidden")}catch(e){console.error("Error loading sessions:",e),this.showToast("Error loading sessions: "+e.message,"error")}finally{this.hideLoading()}}async resetDatabase(){if(confirm("Adakah anda pasti mahu reset database? Semua data akan hilang dan komponen demo akan dijana semula."))try{if(this.showLoading(),!(await fetch(`${e}/api/reset-db`,{method:"POST"})).ok)throw new Error("Failed to reset database");this.showToast("Database berjaya direset dengan komponen demo yang betul","success"),await this.loadInitialData(),this.currentSession&&this.resetToWorkerSelection()}catch(e){console.error("Error resetting database:",e),this.showToast("Error resetting database: "+e.message,"error")}finally{this.hideLoading()}}displayAllSessions(e){const t=document.getElementById("sessionsContent"),n=`\n            <h3>Semua Sesi Pemasangan (${e.length})</h3>\n            <div class="sessions-table-container">\n                <table class="sessions-table">\n                    <thead>\n                        <tr>\n                            <th>Pekerja</th>\n                            <th>ID Pekerja</th>\n                            <th>Masa Mula</th>\n                            <th>Masa Tamat</th>\n                            <th>Status</th>\n                            <th>Komponen</th>\n                            <th>Ralat</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n                        ${e.map(e=>`\n                            <tr>\n                                <td>${e.worker_name}</td>\n                                <td>${e.employee_id}</td>\n                                <td>${this.formatTime(e.start_time)}</td>\n                                <td>${e.end_time?this.formatTime(e.end_time):"-"}</td>\n                                <td><span class="status-badge ${e.status}">${e.status}</span></td>\n                                <td>${e.components_installed}</td>\n                                <td>${e.errors_count}</td>\n                            </tr>\n                        `).join("")}\n                    </tbody>\n                </table>\n            </div>\n        `;t.innerHTML=n}closeModal(e){e.classList.add("hidden")}showLoading(){document.getElementById("loadingOverlay").classList.remove("hidden")}hideLoading(){document.getElementById("loadingOverlay").classList.add("hidden")}showToast(e,t="info"){const n=document.createElement("div");n.className=`toast ${t}`,n.textContent=e,document.getElementById("toastContainer").appendChild(n),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},5e3)}formatTime(e){return e?new Date(e).toLocaleString():"-"}}document.addEventListener("DOMContentLoaded",()=>{new t})})();